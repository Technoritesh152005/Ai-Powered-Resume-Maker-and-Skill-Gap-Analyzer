import asyncHandler from "../../utils/asyncHandler"
import ApiError from "../../utils/apiError"
import userModel from "../../models/user.model"
import logger from "../../utils/logs"
import jwt from 'jwt'
import refreshTokenModel from "../../models/refreshToken"

const refreshToken = asyncHandler(async(req,res,next)=>{

    const {refreshToken} = req.body;

    if(!refreshToken){
        throw new ApiError(401,'No Refresh Token Found')
    }
    // to generate access token first we need to check whether that refresh token is of user
    const token = await refreshTokenModel.find({token:refreshToken}).populate('user')
    console.log(token)
    if(!token){
        throw new ApiError(401,"This is not refresh Token Of this user")
    }
    if(!token.isActive){
        throw new ApiError(401,'Refresh Token is not active')
    }
    if(token.isExpired){
        throw new ApiError(401,'Token got expired')
    }

    const user = token.user;
    // now generate token both access and refresh token for security
    const newaccessToken = user.generateAccessToken()
    const newrefreshToken = user.generateRefreshToken()

    if(!(newaccessToken && newrefreshToken)){
        throw new ApiError(500,'Failed difficulty to generate refresh or access token for user')
    }
    // in that same doc update
    // first for security reason we will let keep history which from whom was cancelled and when
   const updateOldToken =  await refreshTokenModel.findByIdAndUpdate(token._id,{
        replacedByToken:newrefreshToken,
        revokedAt:new Date(),
        revokedBy:req.ip
    })

    if(!updateOldToken){
        throw new ApiError(401,'Old Token has not been revoked / Cancelled. Therefore new Refresh Token cannot be created by:'`${req.ip}`)
    }

    const finalrefreshToken = await refreshTokenModel.create({
        token:newrefreshToken,
        user:user._id,
        createdByIp:req.ip,
        expiresAt:new Date(Date.now() + 7 * 60 * 60 * 24 * 1000),
    })

    if(!finalrefreshToken){
        
        throw new ApiError(401,'New refresh Token has not been created')
    }
    logger.info(`New refresh Token has been created for this email: ${user.email}`)

    res.status(200)
    .json(201,'New refresh Token has been generated Succesfully' , {refreshToken:finalrefreshToken, aceessToken:newaccessToken})
})